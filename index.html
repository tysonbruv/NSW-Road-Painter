<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sydney Road Painter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, sans-serif;
}

#map {
  width: 100%;
  height: 100%;
  background: #000;
}

.info {
  position: absolute;
  top: 12px;
  left: 12px;
  background: rgba(0,0,0,0.8);
  color: #fff;
  padding: 10px 14px;
  border-radius: 12px;
  z-index: 1000;
  font-size: 13px;
}

.reset {
  position: absolute;
  top: 12px;
  right: 12px;
  background: #ff8c1a;
  color: #000;
  border: none;
  padding: 10px 14px;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  z-index: 1000;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="info">
  <strong>Sydney Road Painter</strong><br>
  <span id="status">Loading roads…</span>
</div>

<button class="reset" onclick="resetPaint()">Reset</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map('map', {
  zoomControl: false,
  attributionControl: false
}).setView([-33.8688, 151.2093], 13);

// solid black base
L.rectangle(
  [[-90, -180], [90, 180]],
  { color: "#000", fillColor: "#000", fillOpacity: 1, weight: 0 }
).addTo(map);

// storage
const PAINTED = new Set(JSON.parse(localStorage.getItem("paintedRoads") || "[]"));

const roadLayer = L.geoJSON(null, {
  style: f => ({
    color: PAINTED.has(f.properties.id) ? "#ff8c1a" : "#2f80ff",
    weight: PAINTED.has(f.properties.id) ? 6 : 2,
    opacity: 1
  })
}).addTo(map);

// fetch Sydney roads
fetch("https://overpass-api.de/api/interpreter", {
  method: "POST",
  body: `
[out:json];
(
  way["highway"]( -34.1,150.8,-33.6,151.35 );
);
out geom;
`
})
.then(r => r.json())
.then(data => {
  const features = data.elements.map(w => ({
    type: "Feature",
    geometry: {
      type: "LineString",
      coordinates: w.geometry.map(p => [p.lon, p.lat])
    },
    properties: { id: w.id }
  }));

  roadLayer.addData(features);
  document.getElementById("status").textContent = "Painting roads…";
});

// user marker
const user = L.circleMarker([0,0], {
  radius: 6,
  color: "#ff8c1a",
  fillColor: "#ff8c1a",
  fillOpacity: 1
}).addTo(map);

// paint nearest road
function paintNearest(latlng) {
  let closest = null;
  let minDist = Infinity;

  roadLayer.eachLayer(l => {
    const d = L.GeometryUtil.distanceSegment(
      map,
      latlng,
      l.getLatLngs()[0],
      l.getLatLngs()[l.getLatLngs().length - 1]
    );
    if (d < minDist) {
      minDist = d;
      closest = l;
    }
  });

  if (closest) {
    PAINTED.add(closest.feature.properties.id);
    localStorage.setItem("paintedRoads", JSON.stringify([...PAINTED]));
    closest.setStyle({ color: "#ff8c1a", weight: 6 });
  }
}

// GPS
navigator.geolocation.watchPosition(pos => {
  const ll = [pos.coords.latitude, pos.coords.longitude];
  user.setLatLng(ll);
  map.setView(ll);
  paintNearest(L.latLng(ll));
});

// reset
function resetPaint() {
  localStorage.removeItem("paintedRoads");
  location.reload();
}
</script>

</body>
</html>
