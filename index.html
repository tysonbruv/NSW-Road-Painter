<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NSW Road Painter – Three Layer Model</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #000;
}

#map {
  width: 100%;
  height: 100%;
}

.info {
  position: absolute;
  top: 12px;
  left: 12px;
  background: rgba(20,20,20,0.9);
  color: #fff;
  padding: 10px 12px;
  border-radius: 12px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  z-index: 1000;
}

.info small {
  opacity: 0.7;
}

.reset {
  position: absolute;
  top: 12px;
  right: 12px;
  background: #ff8c1a;
  color: #000;
  padding: 8px 14px;
  border-radius: 12px;
  font-weight: 600;
  font-family: system-ui;
  cursor: pointer;
  z-index: 1000;
}
</style>
</head>
<body>

<div id="map"></div>

<div class="info">
  <strong>NSW Road Painter</strong><br>
  <small id="status">Waiting for GPS…</small>
</div>

<div class="reset" onclick="resetPaint()">Reset</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/*************************************************
 * MAP INITIALISATION
 *************************************************/

const NSW_BOUNDS = L.latLngBounds(
  [-37.505, 140.999],
  [-28.157, 153.638]
);

const map = L.map('map', {
  zoomControl: false,
  attributionControl: false,
  maxBounds: NSW_BOUNDS,
  maxBoundsViscosity: 1.0,
  minZoom: 6,
  maxZoom: 18
}).fitBounds(NSW_BOUNDS);

/*************************************************
 * PANE ORDER (BOTTOM → TOP)
 *************************************************/
map.createPane('basePane');
map.createPane('paintPane');
map.createPane('roadPane');

map.getPane('basePane').style.zIndex = 200;
map.getPane('paintPane').style.zIndex = 400;
map.getPane('roadPane').style.zIndex = 600;

/*************************************************
 * BOTTOM LAYER — SOLID GREY NSW BASE
 *************************************************/
L.rectangle(NSW_BOUNDS, {
  pane: 'basePane',
  fillColor: '#2a2a2a',
  fillOpacity: 1,
  stroke: false
}).addTo(map);

/*************************************************
 * MIDDLE LAYER — ORANGE PAINT + USER
 *************************************************/
const paintLayer = L.layerGroup({ pane: 'paintPane' }).addTo(map);

const userMarker = L.rectangle([[0,0],[0,0]], {
  pane: 'paintPane',
  fillColor: '#ff8c1a',
  fillOpacity: 1,
  stroke: false
}).addTo(map);

/*************************************************
 * TOP LAYER — NSW ROADS (VECTOR MASK)
 *************************************************/
const roadLayer = L.geoJSON(null, {
  pane: 'roadPane',
  style: {
    color: '#b0b0b0',
    weight: 6,
    opacity: 0.05
  }
}).addTo(map);

function loadRoads(center) {
  const query = `
    [out:json];
    way[highway](around:1500,${center.lat},${center.lng});
    out geom;
  `;

  fetch('https://overpass-api.de/api/interpreter', {
    method: 'POST',
    body: query
  })
  .then(r => r.json())
  .then(data => {
    const features = data.elements.map(e => ({
      type: 'Feature',
      geometry: {
        type: 'LineString',
        coordinates: e.geometry.map(p => [p.lon, p.lat])
      }
    }));
    roadLayer.addData(features);
  });
}

/*************************************************
 * PAINTING LOGIC
 *************************************************/
const PAINT_RADIUS_METERS = 60;
const painted = new Set();

function paintAt(latlng) {
  const key = latlng.lat.toFixed(5) + ',' + latlng.lng.toFixed(5);
  if (painted.has(key)) return;
  painted.add(key);

  L.circle(latlng, {
    pane: 'paintPane',
    radius: PAINT_RADIUS_METERS,
    fillColor: '#ff8c1a',
    fillOpacity: 1,
    stroke: false
  }).addTo(paintLayer);
}

/*************************************************
 * GPS TRACKING
 *************************************************/
navigator.geolocation.watchPosition(
  pos => {
    const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);

    if (!NSW_BOUNDS.contains(latlng)) {
      document.getElementById('status').textContent = 'Outside NSW';
      return;
    }

    map.setView(latlng, map.getZoom(), { animate: false });

    const size = 0.00012;
    userMarker.setBounds([
      [latlng.lat - size, latlng.lng - size],
      [latlng.lat + size, latlng.lng + size]
    ]);

    paintAt(latlng);

    if (!window.roadsLoaded) {
      loadRoads(latlng);
      window.roadsLoaded = true;
    }

    document.getElementById('status').textContent = 'Painting roads…';
  },
  err => {
    document.getElementById('status').textContent = 'Location denied';
  },
  {
    enableHighAccuracy: true,
    maximumAge: 1000,
    timeout: 10000
  }
);

/*************************************************
 * RESET
 *************************************************/
function resetPaint() {
  if (!confirm('Clear painted area?')) return;
  paintLayer.clearLayers();
  painted.clear();
}
</script>
</body>
</html>
