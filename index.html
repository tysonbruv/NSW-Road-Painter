<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NSW Road Painter – Radius Reveal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}
#map {
  width: 100%;
  height: 100%;
}
.info {
  position: absolute;
  top: 12px;
  left: 12px;
  background: rgba(16,16,16,0.9);
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 13px;
  color: #f5f5f5;
  z-index: 1000;
}
.status {
  font-size: 11px;
  opacity: 0.7;
  margin-top: 4px;
}
.reset {
  position: absolute;
  top: 12px;
  right: 12px;
  background: #ff7a18;
  border: none;
  color: #000;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  cursor: pointer;
  z-index: 1000;
}
</style>
</head>
<body>
<div id="map"></div>
<div class="info">
  <strong>NSW Road Painter</strong>
  <div class="status" id="status">Waiting for location…</div>
</div>
<button class="reset" onclick="resetPaint()">Reset</button>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ---------------- NSW BOUNDS ----------------
const NSW_BOUNDS = L.latLngBounds(
  [-37.505, 140.999],
  [-28.157, 153.638]
);

// ---------------- MAP ----------------
const map = L.map('map', {
  zoomControl: false,
  attributionControl: false,
  maxBounds: NSW_BOUNDS,
  maxBoundsViscosity: 1.0,
  minZoom: 6,
  maxZoom: 18
}).fitBounds(NSW_BOUNDS);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
  subdomains: 'abcd'
}).addTo(map);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
  opacity: 0.35,
  subdomains: 'abcd'
}).addTo(map);

// ---------------- USER DOT ----------------
const userDot = L.circleMarker([0,0], {
  radius: 6,
  color: '#ff7a18',
  fillColor: '#ff7a18',
  fillOpacity: 1,
  weight: 0
}).addTo(map);

// ---------------- PAINT LAYER ----------------
const paintLayer = L.layerGroup().addTo(map);
const STORAGE_KEY = 'nsw_radius_reveal';
let painted = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));

const GRID = 0.0004;        // grid resolution
const RADIUS_M = 80;        // reveal radius in meters

function gridKey(lat, lng) {
  return `${lat.toFixed(4)},${lng.toFixed(4)}`;
}

function revealArea(center) {
  const lat = center.lat;
  const lng = center.lng;

  for (let dx = -4; dx <= 4; dx++) {
    for (let dy = -4; dy <= 4; dy++) {
      const pLat = lat + dx * GRID;
      const pLng = lng + dy * GRID;
      const point = L.latLng(pLat, pLng);

      if (center.distanceTo(point) > RADIUS_M) continue;
      if (!NSW_BOUNDS.contains(point)) continue;

      const key = gridKey(pLat, pLng);
      if (painted.has(key)) continue;

      painted.add(key);
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...painted]));

      L.circleMarker(point, {
        radius: 6,
        color: '#ff7a18',
        fillColor: '#ff7a18',
        fillOpacity: 0.9,
        weight: 0
      }).addTo(paintLayer);
    }
  }
}

// ---------------- GEOLOCATION ----------------
function startTracking() {
  if (!navigator.geolocation) {
    document.getElementById('status').textContent = 'Geolocation unsupported';
    return;
  }

  navigator.geolocation.watchPosition(pos => {
    const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);

    if (!NSW_BOUNDS.contains(latlng)) {
      document.getElementById('status').textContent = 'Outside NSW';
      return;
    }

    map.setView(latlng, 17);
    userDot.setLatLng(latlng);
    revealArea(latlng);

    document.getElementById('status').textContent = 'Painting roads…';
  }, err => {
    document.getElementById('status').textContent = 'Location permission denied';
  }, {
    enableHighAccuracy: true,
    maximumAge: 1000,
    timeout: 10000
  });
}

// ---------------- RESET ----------------
function resetPaint() {
  if (!confirm('Clear painted areas?')) return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

startTracking();
</script>
</body>
</html>
