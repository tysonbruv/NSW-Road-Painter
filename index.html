<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NSW Road Painter – v1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}
#map { width: 100%; height: 100%; }
.info {
  position: absolute; top: 12px; left: 12px;
  background: rgba(0,0,0,0.75);
  padding: 12px 14px; border-radius: 12px;
  color: #fff; font-size: 13px; z-index: 1000;
}
.status { font-size: 11px; opacity: 0.7; }
.reset {
  position: absolute; top: 12px; right: 12px;
  background: #ff8c1a; border: none; padding: 10px 14px;
  border-radius: 10px; font-weight: 600; cursor: pointer; z-index: 1000;
}
</style>
</head>
<body>
<div id="map"></div>
<div class="info">
  <strong>NSW Road Painter</strong>
  <div class="status" id="status">Waiting for GPS…</div>
</div>
<button class="reset" onclick="resetPaint()">Reset</button>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===================== BOUNDS =====================
const NSW_BOUNDS = L.latLngBounds([-37.505, 140.999], [-28.157, 153.638]);
const GRID = 0.00025;
const STORAGE_KEY = 'nsw_paint_cells';
// ===================== MAP =====================
const map = L.map('map', {
  zoomControl: false,
  attributionControl: false,
  minZoom: 6,
  maxZoom: 18,
  maxBounds: NSW_BOUNDS,
  maxBoundsViscosity: 1
}).fitBounds(NSW_BOUNDS);
// ===================== PANES =====================
map.createPane('base');
map.createPane('paint');
map.createPane('roads');
map.getPane('base').style.zIndex  = 100;
map.getPane('paint').style.zIndex = 300;
map.getPane('roads').style.zIndex = 600;
// ===================== BASE LAYER =====================
L.rectangle(NSW_BOUNDS, {
  pane: 'base', fillColor: '#2b2b2b', fillOpacity: 1, weight: 0
}).addTo(map);
// ===================== ROAD MASK =====================
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
  pane: 'roads', opacity: 1
}).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
  pane: 'roads', opacity: 0.05
}).addTo(map);
// ===================== PAINT =====================
const painted = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));
function snap(ll) {
  const lat = Math.round(ll.lat / GRID) * GRID;
  const lng = Math.round(ll.lng / GRID) * GRID;
  return `${lat.toFixed(5)},${lng.toFixed(5)}`;
}
function paint(cell) {
  if (painted.has(cell)) return;
  painted.add(cell);
  localStorage.setItem(STORAGE_KEY, JSON.stringify([...painted]));
  const [lat, lng] = cell.split(',').map(Number);
  L.rectangle([
    [lat - GRID/2, lng - GRID/2],
    [lat + GRID/2, lng + GRID/2]
  ], { pane: 'paint', fillColor: '#ff8c1a', fillOpacity: 1, weight: 0 }).addTo(map);
}
// ===================== USER =====================
const user = L.rectangle([[0,0],[0,0]], {
  pane: 'paint', fillColor: '#ff8c1a', fillOpacity: 1, weight: 0
}).addTo(map);
let last = null;
// ===================== GPS =====================
navigator.geolocation.watchPosition(pos => {
  const ll = L.latLng(pos.coords.latitude, pos.coords.longitude);
  if (!NSW_BOUNDS.contains(ll)) {
    document.getElementById('status').textContent = 'Outside NSW'; return;
  }
  const cell = snap(ll);
  if (cell !== last) { paint(cell); last = cell; }
  user.setBounds([
    [ll.lat - GRID, ll.lng - GRID],
    [ll.lat + GRID, ll.lng + GRID]
  ]);
  map.setView(ll, 17);
  document.getElementById('status').textContent = 'Painting roads…';
}, () => {
  document.getElementById('status').textContent = 'Location denied';
}, { enableHighAccuracy: true, maximumAge: 1000 });
// ===================== RESET =====================
function resetPaint() {
  if (!confirm('Clear painted roads?')) return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}
</script>
</body>
</html>
