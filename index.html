<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NSW Road Painter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  height: 100%;
}

#map {
  width: 100%;
  height: 100%;
}

/* UI */
.info {
  position: absolute;
  top: 12px;
  left: 12px;
  background: rgba(20,20,20,0.9);
  color: #fff;
  padding: 12px 14px;
  border-radius: 14px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  z-index: 999;
}

.info small {
  opacity: 0.7;
}

.reset {
  position: absolute;
  top: 12px;
  right: 12px;
  background: #ff8c1a;
  color: #000;
  padding: 10px 16px;
  border-radius: 14px;
  font-weight: 600;
  font-family: system-ui;
  cursor: pointer;
  z-index: 999;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="info">
  <strong>NSW Road Painter</strong><br />
  <small id="status">Waiting for GPS…</small>
</div>

<div class="reset" onclick="resetPaint()">Reset</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   MAP SETUP
========================= */

const map = L.map('map', {
  zoomControl: false,
  attributionControl: false
}).setView([-33.85, 150.9], 17);

/* Solid black base (100% opaque) */
L.rectangle(
  [[-90, -180], [90, 180]],
  { color: '#000', weight: 0, fillOpacity: 1 }
).addTo(map);

/* =========================
   ORANGE PAINT LAYER
========================= */

const paintLayer = L.layerGroup().addTo(map);

/* =========================
   USER MARKER
========================= */

const userMarker = L.rectangle([[0,0],[0,0]], {
  color: '#ff8c1a',
  weight: 0,
  fillOpacity: 1
}).addTo(map);

/* =========================
   ROAD MASK (GREY @ 5%)
========================= */

const roadLayer = L.geoJSON(null, {
  style: {
    color: '#aaa',
    weight: 6,
    opacity: 0.05
  }
}).addTo(map);

/* Load roads from OSM Overpass */
function loadRoads(center) {
  const radius = 1200;
  const query = `
    [out:json];
    way
      ["highway"]
      (around:${radius},${center.lat},${center.lng});
    out geom;
  `;

  fetch('https://overpass-api.de/api/interpreter', {
    method: 'POST',
    body: query
  })
  .then(r => r.json())
  .then(data => {
    const features = data.elements.map(e => ({
      type: 'Feature',
      geometry: {
        type: 'LineString',
        coordinates: e.geometry.map(p => [p.lon, p.lat])
      }
    }));
    roadLayer.addData(features);
  });
}

/* =========================
   PAINTING LOGIC
========================= */

const paintRadiusMeters = 60;
const paintedCells = new Set();

function paintAt(latlng) {
  const key =
    latlng.lat.toFixed(5) + ',' + latlng.lng.toFixed(5);

  if (paintedCells.has(key)) return;
  paintedCells.add(key);

  const circle = L.circle(latlng, {
    radius: paintRadiusMeters,
    color: '#ff8c1a',
    weight: 0,
    fillOpacity: 1
  });

  paintLayer.addLayer(circle);
}

/* =========================
   GPS TRACKING
========================= */

navigator.geolocation.watchPosition(
  pos => {
    const latlng = {
      lat: pos.coords.latitude,
      lng: pos.coords.longitude
    };

    document.getElementById('status').textContent =
      'Painting roads…';

    map.setView(latlng, map.getZoom(), { animate: false });

    /* User square (slightly wider than roads) */
    const size = 0.00012;
    userMarker.setBounds([
      [latlng.lat - size, latlng.lng - size],
      [latlng.lat + size, latlng.lng + size]
    ]);

    paintAt(latlng);

    if (!window.roadsLoaded) {
      loadRoads(latlng);
      window.roadsLoaded = true;
    }
  },
  err => {
    document.getElementById('status').textContent =
      'Location permission denied';
  },
  {
    enableHighAccuracy: true,
    maximumAge: 1000,
    timeout: 10000
  }
);

/* =========================
   RESET
========================= */

function resetPaint() {
  if (!confirm('Clear painted roads?')) return;
  paintLayer.clearLayers();
  paintedCells.clear();
}
</script>

</body>
</html>
