<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NSW Road Painter – v1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

#map {
  width: 100%;
  height: 100%;
  background: #000;
}

.info {
  position: absolute;
  top: 12px;
  left: 12px;
  background: rgba(16,16,16,0.9);
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 13px;
  color: #f5f5f5;
  box-shadow: 0 0 20px rgba(0,0,0,0.6);
  z-index: 1000;
}

.status {
  font-size: 11px;
  opacity: 0.7;
  margin-top: 4px;
}

.reset {
  position: absolute;
  top: 12px;
  right: 12px;
  background: #ff7a18;
  border: none;
  color: #000;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  cursor: pointer;
  z-index: 1000;
}

.reset:hover { opacity: 0.9; }
</style>
</head>
<body>

<div id="map"></div>

<div class="info">
  <div><strong>NSW Road Painter</strong></div>
  <div class="status" id="status">Waiting for location…</div>
</div>

<button class="reset" onclick="resetPaint()">Reset</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ---------------- NSW BOUNDS ----------------
const NSW_BOUNDS = L.latLngBounds(
  [-37.505, 140.999],
  [-28.157, 153.638]
);

// Approximate NSW border polygon (for prototype visualisation)
const NSW_BORDER = [
  [-37.505, 141.002],
  [-36.5, 141.1],
  [-34.5, 141.0],
  [-32.5, 141.0],
  [-30.5, 141.0],
  [-28.157, 141.0],
  [-28.157, 153.638],
  [-32.0, 153.3],
  [-34.5, 152.5],
  [-36.5, 150.0],
  [-37.505, 149.5],
  [-37.505, 141.002]
];

// ---------------- MAP SETUP ----------------
const map = L.map('map', {
  zoomControl: false,
  attributionControl: false,
  maxBounds: NSW_BOUNDS,
  maxBoundsViscosity: 1.0,
  minZoom: 6,
  maxZoom: 18
}).fitBounds(NSW_BOUNDS);

// Black base, no labels
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
  maxZoom: 18,
  subdomains: 'abcd'
}).addTo(map);

// Subtle grey roads
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
  opacity: 0.35,
  subdomains: 'abcd'
}).addTo(map);

// NSW Border Highlight
L.polyline(NSW_BORDER, {
  color: '#ffcc00',
  weight: 4,
  opacity: 0.9
}).addTo(map);

// ---------------- STORAGE ----------------
const STORAGE_KEY = 'nsw_painted_cells';
let painted = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));

// ---------------- PAINTING GRID (PROXY) ----------------
const gridSize = 0.0003;
let lastCell = null;

function snapToGrid(latlng) {
  const lat = Math.round(latlng.lat / gridSize) * gridSize;
  const lng = Math.round(latlng.lng / gridSize) * gridSize;
  return `${lat.toFixed(4)},${lng.toFixed(4)}`;
}

function paintCell(cell) {
  if (painted.has(cell)) return;
  painted.add(cell);
  localStorage.setItem(STORAGE_KEY, JSON.stringify([...painted]));

  const [lat, lng] = cell.split(',').map(Number);
  L.circleMarker([lat, lng], {
    radius: 5,
    color: '#ff7a18',
    fillColor: '#ff7a18',
    fillOpacity: 0.9,
    weight: 0
  }).addTo(map);
}

// ---------------- USER MARKER ----------------
const userMarker = L.circleMarker([0, 0], {
  radius: 7,
  color: '#f5f5f5',
  weight: 2,
  fillOpacity: 0,
  opacity: 0.85
}).addTo(map);

// ---------------- GEOLOCATION ----------------
function startTracking() {
  if (!navigator.geolocation) {
    document.getElementById('status').textContent = 'Geolocation not supported';
    return;
  }

  navigator.geolocation.watchPosition(pos => {
    const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);

    if (!NSW_BOUNDS.contains(latlng)) {
      document.getElementById('status').textContent = 'Outside NSW';
      return;
    }

    map.setView(latlng, 17);
    userMarker.setLatLng(latlng);

    const cell = snapToGrid(latlng);
    if (cell !== lastCell) {
      paintCell(cell);
      lastCell = cell;
    }

    document.getElementById('status').textContent = 'Painting roads…';
  }, err => {
    document.getElementById('status').textContent = 'Location permission denied';
  }, {
    enableHighAccuracy: true,
    maximumAge: 1000,
    timeout: 10000
  });
}

// ---------------- RESET ----------------
function resetPaint() {
  if (!confirm('Clear painted roads?')) return;
  painted.clear();
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

startTracking();
</script>
</body>
</html>
